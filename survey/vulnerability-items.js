
const location_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "Location" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "dropdown",
            name: "A-LOC3",
            title: LOC_COUNTRY_TITLE,
            isRequired: true,
            choices: LOC_COUNTRY_CHOICES,
          },
          {
            type: "panel",
            name: "loc1_panel",
            elements: [
              {
                type: "text",
                name: "A-LOC1",
                title: LOC_POSTAL_TITLE,
                isRequired: true,
                visibleIf: "{A-LOC1-opt} empty",
              },
              {
                type: "checkbox",
                name: "A-LOC1-opt",
                title: " ",
                choices: LOC_CHOICES,
                colCount: 1,
              },
            ],
          },
          {
            type: "panel",
            name: "loc2_panel",
            elements: [
              {
                type: "text",
                name: "A-LOC2",
                title: LOC_POSTAL_CURRENT_TITLE,
                isRequired: true,
                visibleIf: "{A-LOC2-opt} empty",
              },
              {
                type: "checkbox",
                name: "A-LOC2-opt",
                title: " ",
                choices: LOC_CHOICES,
                colCount: 1,
              },
            ],
          },
        ],
      },
    ],
  },
  min_width: "min(100vw, 1200px)",
};

const work_conditions_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "WorkConditions" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "radiogroup",
            name: "A-WORK1",
            title: WC_EMPLOYMENT_TITLE,
            choices: WC_EMPLOYMENT_CHOICES,
            isRequired: true,
            colCount: 1,
            showOtherItem: true,
            otherText: WC_EMPLOYMENT_OTHER_TEXT,
          },
          {
            type: "radiogroup",
            name: "A-WORK2",
            title: WC_LOCATION_TITLE,
            choices: WC_LOCATION_CHOICES,
            isRequired: true,
            colCount: 1,
          },
          {
            type: "radiogroup",
            name: "A-WORK3",
            title: WC_PHYSICAL_TITLE,
            choices: WC_PHYSICAL_CHOICES,
            isRequired: true,
            colCount: 1,
          },
        ],
      },
    ],
  },
  min_width: "min(100vw, 1200px)",
};

const health_conditions_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "HealthConditions" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "html",
            html: `<p style="font-weight: 600; margin-bottom: 20px;">${MH_PREAMBLE}</p>`,
          },
          {
            type: "checkbox",
            name: "A-MPC1a",
            title: MH_MENTAL_TITLE,
            choices: MH_MENTAL_CHOICES,
            isRequired: true,
            colCount: 1,
            showNoneItem: true,
            noneText: MH_NONE_TEXT,
            showRefuseItem: true,
            refuseText: MH_REFUSE_TEXT,
          },
          {
            type: "checkbox",
            name: "A-MPC1b",
            title: MH_PHYSICAL_TITLE,
            choices: MH_PHYSICAL_CHOICES,
            isRequired: true,
            colCount: 1,
            showNoneItem: true,
            noneText: MH_NONE_TEXT,
            showRefuseItem: true,
            refuseText: MH_REFUSE_TEXT,
          },
          {
            type: "radiogroup",
            name: "A-MPC2",
            title: MH_SYMPTOMS_TITLE,
            choices: MH_SYMPTOMS_SCALE.map((label, i) => ({
              value: i,
              text: label,
            })),
            isRequired: true,
            colCount: 1,
            visibleIf: "({A-MPC1a} notempty and {A-MPC1a} notcontains 'none' and {A-MPC1a} notcontains 'refused') or ({A-MPC1b} notempty and {A-MPC1b} notcontains 'none' and {A-MPC1b} notcontains 'refused')",
          },
          {
            type: "radiogroup",
            name: "A-MPC3",
            title: MH_WEIGHT_TITLE,
            choices: MH_WEIGHT_CHOICES,
            isRequired: true,
            colCount: 1,
          },
          {
            type: "radiogroup",
            name: "A-MPC4",
            title: MH_DEHYDRATION_TITLE,
            choices: MH_DEHYDRATION_SCALE.map((label, i) => ({
              value: i,
              text: label,
            })),
            isRequired: true,
            colCount: 1,
          },
        ],
      },
    ],
  },
  min_width: "min(100vw, 1200px)",
};

const chronic_pain_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "ChronicPain" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "radiogroup",
            name: "A-CP1",
            title: CP_EXPERIENCE_TITLE,
            choices: CP_EXPERIENCE_CHOICES,
            isRequired: true,
            colCount: 1,
          },
          {
            type: "panel",
            name: "pain_questions_panel",
            visibleIf: "{A-CP1} <> 'Never'",
            elements: [
              {
                type: "html",
                html: `<p style="font-weight: 600; margin-bottom: 20px;">${CP_PREAMBLE}</p>`,
              },
              {
                type: "slider",
                name: "M-CP2",
                title: CP_STRENGTH_TITLE,
                min: 0,
                max: 10,
                step: 1,
                isRequired: true,
                customLabels: [
                  { value: 0, text: CP_STRENGTH_LABELS[0] },
                  { value: 5, text: CP_STRENGTH_LABELS[1] },
                  { value: 10, text: CP_STRENGTH_LABELS[2] },
                ],
              },
              {
                type: "slider",
                name: "M-CP3",
                title: CP_DISTRESS_TITLE,
                min: 0,
                max: 10,
                step: 1,
                isRequired: true,
                customLabels: [
                  { value: 0, text: CP_DISTRESS_LABELS[0] },
                  { value: 5, text: CP_DISTRESS_LABELS[1] },
                  { value: 10, text: CP_DISTRESS_LABELS[2] },
                ],
              },
              {
                type: "slider",
                name: "M-CP4",
                title: CP_INTERFERENCE_TITLE,
                min: 0,
                max: 10,
                step: 1,
                isRequired: true,
                customLabels: [
                  { value: 0, text: CP_INTERFERENCE_LABELS[0] },
                  { value: 5, text: CP_INTERFERENCE_LABELS[1] },
                  { value: 10, text: CP_INTERFERENCE_LABELS[2] },
                ],
              },
              {
                type: "text",
                name: "M-CP5",
                title: CP_SOURCE_TITLE,
                isRequired: false,
              },
            ],
          },
        ],
      },
    ],
  },
  on_load: function () {
    // Generate random number to determine 20% sample
    const showPainQuestions = Math.random() < 0.2;
    jsPsych.data.addProperties({
      show_pain_for_never: showPainQuestions
    });
  },
  survey_function: function (survey) {
    // Get the random flag
    const showPainQuestions = jsPsych.data.get().last(1).values()[0].show_pain_for_never;

    // Update visibility condition for the panel
    const panel = survey.getQuestionByName("pain_questions_panel");
    if (panel && showPainQuestions) {
      // Show for not Never OR (Never + random 20%)
      panel.visibleIf = "{A-CP1} <> 'Never' or ({A-CP1} = 'Never' and {show_random_pain} = true)";
    }

    // Add random flag as hidden question value if needed
    if (showPainQuestions) {
      const randomValue = survey.addNewQuestion("boolean", "show_random_pain");
      randomValue.visible = false;
      randomValue.value = true;
    }

    survey.getAllQuestions().forEach((question) => {
      if (question.getType() === "slider") {
        question.handlePointerDown = function () {
          question.oldValue = question.renderedValue;
          question.animatedThumb = false;
        };

        question.handlePointerUp = function (event) {
          event.stopPropagation();
          question.setSliderValue(question.renderedValue);
          question.refreshInputRange();
          question.oldValue = null;
        };
      }
    });
  },
  min_width: "min(100vw, 1200px)",
};

const loneliness_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "Loneliness" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "matrix",
            name: "loneliness",
            title: LS_PREAMBLE,
            rows: Object.keys(LS_PROMPTS).map((key) => ({
              value: `A-${key}`,
              text: LS_PROMPTS[key],
            })),
            columns: LS_SCALE.map((label, i) => ({
              value: i,
              text: label,
            })),
            isRequired: true,
          },
        ],
      },
    ],
  },
  min_width: "min(100vw, 1200px)",
};

const resilience_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "Resilience" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "matrix",
            name: "resilience",
            title: BRS_PREAMBLE,
            rows: Object.keys(BRS_PROMPTS).map((key) => ({
              value: `A-${key}`,
              text: BRS_PROMPTS[key],
            })),
            columns: BRS_SCALE.map((label, i) => ({
              value: i,
              text: label,
            })),
            isRequired: true,
          },
        ],
      },
    ],
  },
  min_width: "min(100vw, 1200px)",
};

const green_blue_spaces_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "GreenBlueSpaces" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "matrix",
            name: "green_blue",
            title: GBS_PREAMBLE,
            rows: Object.keys(GBS_PROMPTS).map((key) => ({
              value: `A-${key}`,
              text: GBS_PROMPTS[key],
            })),
            columns: GBS_SCALE.map((label, i) => ({
              value: i,
              text: label,
            })),
            isRequired: true,
          },
        ],
      },
    ],
  },
  min_width: "min(100vw, 1200px)",
};

const ac_access_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "ACAccess" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "html",
            html: `<p style="font-weight: 600; margin-bottom: 20px;">${AC_ACCESS_PREAMBLE}</p>`,
          },
          {
            type: "radiogroup",
            name: "A-AC1",
            title: AC_HOME_TITLE,
            choices: AC_HOME_CHOICES,
            isRequired: true,
            colCount: 1,
          },
          {
            type: "slider",
            name: "A-AC2",
            title: AC_HOURS_TITLE,
            min: 0,
            max: 48,
            step: 1,
            isRequired: true,
            displayMode: "buttons",
            customLabels: [
              { value: 0, text: "0" },
              { value: 12, text: "12" },
              { value: 24, text: "24" },
              { value: 36, text: "36" },
              { value: 48, text: "48" },
            ],
          },
          {
            type: "radiogroup",
            name: "A-AC3",
            title: AC_SLEEP_TITLE,
            choices: AC_SLEEP_CHOICES,
            isRequired: true,
            colCount: 1,
            visibleIf: "{A-AC1} = 'Yes'",
          },
          {
            type: "radiogroup",
            name: "A-AC4",
            title: AC_LIMIT_TITLE,
            choices: AC_LIMIT_CHOICES,
            isRequired: true,
            colCount: 1,
            visibleIf: "{A-AC1} = 'Yes'",
          },
          {
            type: "radiogroup",
            name: "A-AC5",
            title: AC_OTHER_TITLE,
            choices: AC_OTHER_CHOICES,
            isRequired: true,
            colCount: 1,
            showOtherItem: true,
            otherText: AC_OTHER_TEXT,
          },
        ],
      },
    ],
  },
  survey_function: function (survey) {
    survey.getAllQuestions().forEach((question) => {
      if (question.getType() === "slider") {
        question.handlePointerDown = function () {
          question.oldValue = question.renderedValue;
          question.animatedThumb = false;
        };

        question.handlePointerUp = function (event) {
          event.stopPropagation();
          question.setSliderValue(question.renderedValue);
          question.refreshInputRange();
          question.oldValue = null;
        };
      }
    });
  },
  min_width: "min(100vw, 1200px)",
};

const housing_conditions_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "HousingConditions" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "html",
            html: `<p style="font-weight: 600; margin-bottom: 20px;">${HC_PREAMBLE}</p>`,
          },
          {
            type: "radiogroup",
            name: "A-HC1",
            title: HC_OWN_TITLE,
            choices: HC_OWN_CHOICES,
            isRequired: true,
            colCount: 1,
          },
          {
            type: "radiogroup",
            name: "A-HC2",
            title: HC_TYPE_TITLE,
            choices: HC_TYPE_CHOICES,
            isRequired: true,
            colCount: 1,
            showOtherItem: true,
            otherText: HC_TYPE_OTHER_TEXT,
          },
          {
            type: "radiogroup",
            name: "A-HC3",
            title: HC_TOP_FLOOR_TITLE,
            choices: HC_TOP_FLOOR_CHOICES,
            isRequired: true,
            colCount: 1,
            visibleIf: "{A-HC2} = 4 or {A-HC2} = 5",
          },
          {
            type: "radiogroup",
            name: "A-HC4",
            title: HC_OUTDOOR_TITLE,
            choices: HC_OUTDOOR_CHOICES,
            isRequired: true,
            colCount: 1,
          },
          {
            type: "radiogroup",
            name: "A-HC5",
            title: HC_SIZE_TITLE,
            choices: HC_SIZE_CHOICES,
            isRequired: true,
            colCount: 1,
          },
          {
            type: "radiogroup",
            name: "A-HC6",
            title: HC_WINDOWS_TITLE,
            choices: HC_WINDOWS_CHOICES,
            isRequired: true,
            colCount: 1,
          },
          {
            type: "radiogroup",
            name: "A-HC7",
            title: HC_CROSS_VENT_TITLE,
            choices: HC_CROSS_VENT_CHOICES,
            isRequired: true,
            colCount: 1,
          },
          {
            type: "radiogroup",
            name: "A-HC8",
            title: HC_SUNLIGHT_TITLE,
            choices: HC_SUNLIGHT_CHOICES,
            isRequired: true,
            colCount: 1,
          },
        ],
      },
    ],
  },
  min_width: "min(100vw, 1200px)",
};

const heat_actions_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "HeatActions" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "radiogroup",
            name: "A-HA1",
            title: HA_AWARENESS_TITLE,
            choices: HA_AWARENESS_CHOICES,
            isRequired: true,
            colCount: 1,
            showOtherItem: true,
            otherText: HA_AWARENESS_OTHER_TEXT,
          },
          {
            type: "slider",
            name: "A-HA2",
            title: HA_SUFFICIENCY_TITLE,
            min: 1,
            max: 5,
            step: 1,
            isRequired: true,
            customLabels: [
              { value: 1, text: "completely insufficient" },
              { value: 5, text: "completely sufficient" }
            ],
          },
        ],
      },
    ],
  },
  survey_function: function (survey) {
    survey.getAllQuestions().forEach((question) => {
      if (question.getType() === "slider") {
        question.handlePointerDown = function () {
          question.oldValue = question.renderedValue;
          question.animatedThumb = false;
        };

        question.handlePointerUp = function (event) {
          event.stopPropagation();
          question.setSliderValue(question.renderedValue);
          question.refreshInputRange();
          question.oldValue = null;
        };
      }
    });
  },
  min_width: "min(100vw, 1200px)",
};

const macarthur_ladder_trial = {
  type: jsPsychSurvey,
  data: { survey_page: "MacArthurLadder" },
  survey_json: {
    showQuestionNumbers: false,
    completeText: "Continue",
    pages: [
      {
        elements: [
          {
            type: "panel",
            name: "macarthur_ladder_panel",
            elements: [
              {
                type: "html",
                name: "ladder-instructions",
                html: MACARTHUR_LADDER_INSTRUCTIONS,
              },
              {
                type: "html",
                name: "ladder-visual",
                html: `
                  <div style="display: flex; justify-content: center; margin: 30px 0;">
                    <div id="macarthur-ladder" style="position: relative; width: 200px; height: 500px;">
                      <!-- Ladder will be created by JavaScript -->
                    </div>
                  </div>
                `,
              },
              {
                type: "html",
                name: "ladder-instruction-select",
                html: `<p style="text-align: center; font-style: italic; margin-top: 20px;">Please click on a rung to select your position on the ladder.</p><div id="ladder-error" style="color: #ed5565; text-align: center; margin-top: 10px; display: none;"></div>`,
              },
              {
                type: "text",
                name: "A-LADDER",
                title: " ",
                isRequired: true,
                inputType: "number",
                min: 1,
                max: 10,
                cssClasses: { root: "ladder-hidden-question-input" },
              },
            ],
          },
          {
            type: "panel",
            name: "macarthur_finances_panel",
            elements: [
              {
                type: "radiogroup",
                name: "A-FINANCES",
                title: MACARTHUR_FINANCES_TITLE,
                choices: MACARTHUR_FINANCES_CHOICES,
                isRequired: true,
                colCount: 1,
              },
            ],
          },
        ],
      },
    ],
  },
  survey_function: function (survey) {
    survey.onAfterRenderQuestion.add(function (sender, options) {
      if (options.question.name === "ladder-visual") {
        const container = document.getElementById("macarthur-ladder");
        if (!container) return;

        // Get the question to update
        const ladderQuestion = survey.getQuestionByName("A-LADDER");

        // Create ladder HTML
        let ladderHTML = `
          <div class="ladder-container">
            <div class="ladder-label">${MACARTHUR_LADDER_TOP_LABEL}</div>
            <div class="ladder-rungs">
              <div class="ladder-side left"></div>
              <div class="ladder-side right"></div>
        `;

        // Create 10 rungs (top to bottom = 10 to 1)
        for (let i = 10; i >= 1; i--) {
          ladderHTML += `
            <div class="ladder-rung" data-value="${i}">
              <div class="ladder-rung-bar"></div>
              <div class="ladder-rung-number">${i}</div>
            </div>
          `;
        }

        ladderHTML += `
            </div>
            <div class="ladder-bottom-label">${MACARTHUR_LADDER_BOTTOM_LABEL}</div>
          </div>
        `;

        container.innerHTML = ladderHTML;

        // Add click handlers
        const rungs = container.querySelectorAll(".ladder-rung");
        rungs.forEach((rung) => {
          rung.addEventListener("click", function () {
            const value = parseInt(this.getAttribute("data-value"));

            // Remove selected class from all rungs
            rungs.forEach((r) => r.classList.remove("selected"));

            // Add selected class to clicked rung
            this.classList.add("selected");

            // Update the hidden question value
            ladderQuestion.value = value;
          });
        });

        // If question already has a value, select that rung
        if (ladderQuestion.value) {
          const selectedRung = container.querySelector(
            `[data-value="${ladderQuestion.value}"]`
          );
          if (selectedRung) {
            selectedRung.classList.add("selected");
          }
        }
      }
    });
  },
  min_width: "min(100vw, 1200px)",
};

const vulnerability_timeline = {
  timeline: [
    macarthur_ladder_trial,
    location_trial,
    work_conditions_trial,
    health_conditions_trial,
    chronic_pain_trial,
    green_blue_spaces_trial,
    ac_access_trial,
    housing_conditions_trial,
    heat_actions_trial,
  ]
}