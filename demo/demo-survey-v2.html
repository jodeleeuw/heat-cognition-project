<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HotCog Demo</title>
    <script src="https://unpkg.com/jspsych@8"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-survey-slider"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css"
    />
    <script src="https://unpkg.com/@jspsych/plugin-survey@4.0.0"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@jspsych/plugin-survey@4.0.0/css/survey.min.css"
    />
    <script src="plugin-survey-vert-slider.js"></script>
    <script src="plugin-survey-svo.js"></script>
    <script src="survey-text.js"></script>
    <style>
      .hotcog-containers {
        padding: 16px;
      }
    </style>
  </head>
  <body>
    <script>

      // todo: randomize order of survey pages (will get paths through)
      // validation/pre-pilot: questionnaire on one
      // get launched for JATOS

      // by november:
      // -- whole package ready to go
      // -- all the tasks working, paths up

      const jsPsych = initJsPsych({
        on_finish: function () {
          jsPsych.data.displayData();
        },
      });

      let timeline = [];

      const who5_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              elements: [
                {
                  type: "matrix",
                  name: "who5",
                  title: WHO5_PREAMBLE,
                  rows: Object.keys(WHO5_PROMPTS).map((key) => ({
                    value: `A-${key}`,
                    text: WHO5_PROMPTS[key],
                  })),
                  columns: WHO5_SCALE.map((label, i) => ({
                    value: i,
                    text: label,
                  })),
                  isRequired: true,
                },
              ],
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const phq4_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              elements: [
                {
                  type: "matrix",
                  name: "phq4",
                  title: PHQ4_PREAMBLE,
                  rows: Object.keys(PHQ4_PROMPTS).map((key) => ({
                    value: `A-${key}`,
                    text: PHQ4_PROMPTS[key],
                  })),
                  columns: PHQ4_SCALE.map((label, i) => ({
                    value: i,
                    text: label,
                  })),
                  isRequired: true,
                },
              ],
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const vams_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              title: VAMS_PREAMBLE,
              elements: [
                {
                  type: "slider",
                  name: "M-VA1",
                  title: VAMS_PROMPTS.VA1,
                  min: 0,
                  max: 100,
                  step: 1,
                  defaultValue: 0,
                  customLabels: [
                    { value: 0, text: VAMS_LABELS[0] },
                    { value: 100, text: VAMS_LABELS[1] },
                  ],
                },
                {
                  type: "slider",
                  name: "M-VA2",
                  title: VAMS_PROMPTS.VA2,
                  min: 0,
                  max: 100,
                  step: 1,
                  defaultValue: 0,
                  customLabels: [
                    { value: 0, text: VAMS_LABELS[0] },
                    { value: 100, text: VAMS_LABELS[1] },
                  ],
                },
                {
                  type: "slider",
                  name: "M-VA3",
                  title: VAMS_PROMPTS.VA3,
                  min: 0,
                  max: 100,
                  step: 1,
                  defaultValue: 0,
                  customLabels: [
                    { value: 0, text: VAMS_LABELS[0] },
                    { value: 100, text: VAMS_LABELS[1] },
                  ],
                },
                {
                  type: "slider",
                  name: "M-VA4",
                  title: VAMS_PROMPTS.VA4,
                  min: 0,
                  max: 100,
                  step: 1,
                  defaultValue: 0,
                  customLabels: [
                    { value: 0, text: VAMS_LABELS[0] },
                    { value: 100, text: VAMS_LABELS[1] },
                  ],
                },
                {
                  type: "slider",
                  name: "M-VA5",
                  title: VAMS_PROMPTS.VA5,
                  min: 0,
                  max: 100,
                  step: 1,
                  defaultValue: 0,
                  customLabels: [
                    { value: 0, text: VAMS_LABELS[0] },
                    { value: 100, text: VAMS_LABELS[1] },
                  ],
                },
                {
                  type: "slider",
                  name: "M-VA6",
                  title: VAMS_PROMPTS.VA6,
                  min: 0,
                  max: 100,
                  step: 1,
                  defaultValue: 0,
                  customLabels: [
                    { value: 0, text: VAMS_LABELS[0] },
                    { value: 100, text: VAMS_LABELS[1] },
                  ],
                },
              ],
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const bpaq_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              title: BPAQ_PREAMBLE,
              elements: Object.keys(BPAQ_PROMPTS).map((key) => ({
                type: "slider",
                name: `M-${key}`,
                title: BPAQ_PROMPTS[key],
                min: 0,
                max: 4,
                step: 1,
                customLabels: [
                  { value: 0, text: BPAQ_SCALE[0] },
                  { value: 4, text: BPAQ_SCALE[4] }
                ]
              }))
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const ac_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              elements: [
                {
                  type: "matrix",
                  name: "ac",
                  title: AC_PREAMBLE,
                  rows: Object.keys(AC_PROMPTS).map((key) => ({
                    value: `M-${key}`,
                    text: AC_PROMPTS[key],
                  })),
                  columns: AC_SCALE.map((label, i) => ({
                    value: i,
                    text: label,
                  })),
                  isRequired: true,
                },
              ],
            },
          ],
        },
      };

      const svo_trials = {
        timeline: [{
          type: jsPsychSurvey,
          survey_json: function() {
            const trial_index = jsPsych.evaluateTimelineVariable('trial_index');
            const name = jsPsych.evaluateTimelineVariable('name');

            const elements = [];

            // Add preamble as separate HTML element on first trial only
            if (trial_index === 0) {
              elements.push({
                type: "html",
                name: "svo-preamble",
                html: `<div style="font-size: 14px; line-height: 1.5; max-width: 700px; margin: 0 auto 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                  ${SVO_PREAMBLE}
                </div>`
              });
            }

            elements.push({
              type: "html",
              name: `svo-trial-${trial_index + 1}-display`,
              html: `<div id="svo-trial-${trial_index + 1}-container" class="svo-container"></div>`
            });

            elements.push({
              type: "radiogroup",
              name: name,
              visible: false,
              isRequired: true,
              choices: [0, 1, 2, 3, 4, 5, 6, 7, 8]
            });

            return {
              showQuestionNumbers: false,
              completeText: "Continue",
              pages: [{
                elements: elements
              }]
            };
          },
          on_load: function() {
            const survey = this.survey;
            const trial_index = jsPsych.evaluateTimelineVariable('trial_index');
            const self_values = jsPsych.evaluateTimelineVariable('self_values');
            const other_values = jsPsych.evaluateTimelineVariable('other_values');
            const name = jsPsych.evaluateTimelineVariable('name');

            // Wait for DOM to be ready
            setTimeout(() => {
              const container = document.getElementById(`svo-trial-${trial_index + 1}-container`);
              if (!container) return;

              // 3x3 grid layout for all screen sizes
              let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 600px; margin: 0 auto;">';

              for (let i = 0; i < self_values.length; i++) {
                html += `
                  <button type="button" class="svo-choice-btn" data-choice="${i}" style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 12px 8px;
                    border: 2px solid #ccc;
                    background: white;
                    cursor: pointer;
                    border-radius: 8px;
                    gap: 4px;
                    min-height: 80px;
                  ">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                      <span style="font-size: 10px; color: #666;">${SVO_SELF_LABEL}</span>
                      <span style="font-size: 16px; font-weight: bold;">${self_values[i]}</span>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px; margin-top: 8px;">
                      <span style="font-size: 10px; color: #666;">${SVO_OTHER_LABEL}</span>
                      <span style="font-size: 16px; font-weight: bold;">${other_values[i]}</span>
                    </div>
                  </button>
                `;
              }

              html += '</div>';
              container.innerHTML = html;

              // Attach click handlers
              const buttons = container.querySelectorAll('.svo-choice-btn');
              buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                  const choice = parseInt(this.getAttribute('data-choice'));

                  // Update visual selection
                  buttons.forEach(b => {
                    b.style.backgroundColor = 'white';
                    b.style.borderColor = '#ccc';
                  });

                  this.style.backgroundColor = '#e0e0e0';
                  this.style.borderColor = '#333';

                  // Update hidden radiogroup
                  survey.setValue(name, choice);
                });
              });
            }, 10);
          }
        }],
        timeline_variables: [
          {
            trial_index: 0,
            self_values: [85, 85, 85, 85, 85, 85, 85, 85, 85],
            other_values: [85, 76, 68, 59, 50, 41, 33, 24, 15],
            name: "M-SVOT1",
          },
          {
            trial_index: 1,
            self_values: [85, 87, 89, 91, 93, 94, 96, 98, 100],
            other_values: [15, 19, 24, 28, 33, 37, 41, 46, 50],
            name: "M-SVOT2",
          },
          {
            trial_index: 2,
            self_values: [50, 54, 59, 63, 68, 72, 76, 81, 85],
            other_values: [100, 98, 96, 94, 93, 91, 89, 87, 85],
            name: "M-SVOT3",
          },
          {
            trial_index: 3,
            self_values: [50, 54, 59, 63, 68, 72, 76, 81, 85],
            other_values: [100, 89, 79, 68, 58, 47, 36, 26, 15],
            name: "M-SVOT4",
          },
          {
            trial_index: 4,
            self_values: [100, 94, 88, 81, 75, 69, 63, 56, 50],
            other_values: [50, 56, 63, 69, 75, 81, 88, 94, 100],
            name: "M-SVOT5",
          },
          {
            trial_index: 5,
            self_values: [100, 98, 96, 94, 93, 91, 89, 87, 85],
            other_values: [50, 54, 59, 63, 68, 72, 76, 81, 85],
            name: "M-SVOT6",
          },
        ]
      };

      const tic_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              elements: [
                {
                  type: "matrix",
                  name: "tic",
                  title: TIC_PREAMBLE,
                  rows: Object.keys(TIC_PROMPTS).map((key) => ({
                    value: `A-${key}`,
                    text: TIC_PROMPTS[key],
                  })),
                  columns: TIC_SCALE.map((label, i) => ({
                    value: i,
                    text: label,
                  })),
                  isRequired: true,
                },
              ],
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const cce_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              elements: [
                {
                  type: "matrix",
                  name: "cce",
                  title: CCE_PREAMBLE,
                  rows: Object.keys(CCE_PROMPTS).map((key) => ({
                    value: `M-${key}`,
                    text: CCE_PROMPTS[key],
                  })),
                  columns: CCE_SCALE.map((label, i) => ({
                    value: i,
                    text: label,
                  })),
                  isRequired: true,
                },
              ],
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const ccj_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              elements: [
                {
                  type: "matrix",
                  name: "ccj",
                  title: CCJ_PREAMBLE,
                  rows: Object.keys(CCJ_PROMPTS).map((key) => ({
                    value: `M-${key}`,
                    text: CCJ_PROMPTS[key],
                  })),
                  columns: CCJ_SCALE.map((label, i) => ({
                    value: i,
                    text: label,
                  })),
                  isRequired: true,
                },
              ],
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const cca_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              elements: [
                {
                  type: "matrix",
                  name: "cca",
                  title: CCA_PREAMBLE,
                  rows: Object.keys(CCA_PROMPTS).map((key) => ({
                    value: `M-${key}`,
                    text: CCA_PROMPTS[key],
                  })),
                  columns: CCA_SCALE.map((label, i) => ({
                    value: i,
                    text: label,
                  })),
                  isRequired: true,
                },
              ],
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const ccb_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              title: CCB_PREAMBLE,
              elements: Object.keys(CCB_PROMPTS).map((key) => ({
                type: "slider",
                name: `M-${key}`,
                title: CCB_PROMPTS[key],
                min: 0,
                max: 4,
                step: 1,
                customLabels: [
                  { value: 0, text: CCB_SCALE[0] },
                  { value: 4, text: CCB_SCALE[4] }
                ]
              }))
            },
          ],
        }
      };

      const ts_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              elements: [
                {
                  type: "radiogroup",
                  name: "A-TS1",
                  title: TS_PROMPTS.TS1.prompt,
                  choices: TS_PROMPTS.TS1.labels.map((label, i) => ({
                    value: i,
                    text: label
                  })),
                  isRequired: true
                },
                {
                  type: "radiogroup",
                  name: "A-TS2",
                  title: TS_PROMPTS.TS2.prompt,
                  choices: TS_PROMPTS.TS2.labels.map((label, i) => ({
                    value: i,
                    text: label
                  })),
                  isRequired: true
                }
              ],
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const sta_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              elements: [
                {
                  type: "matrix",
                  name: "sta",
                  title: STA_PREAMBLE,
                  rows: Object.keys(STA_PROMPTS).map((key) => ({
                    value: `A-${key}`,
                    text: STA_PROMPTS[key],
                  })),
                  columns: STA_SCALE.map((label, i) => ({
                    value: i,
                    text: label,
                  })),
                  isRequired: true,
                },
              ],
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const sl_trial = {
        type: jsPsychSurvey,
        survey_json: {
          showQuestionNumbers: false,
          completeText: "Continue",
          pages: [
            {
              elements: [
                {
                  type: "matrix",
                  name: "sl",
                  title: SL_PREAMBLE,
                  rows: Object.keys(SL_PROMPTS).map((key) => ({
                    value: `A-${key}`,
                    text: SL_PROMPTS[key],
                  })),
                  columns: SL_SCALE.map((label, i) => ({
                    value: i,
                    text: label,
                  })),
                  isRequired: true,
                },
              ],
            },
          ],
        },
        min_width: "min(100vw, 1200px)"
      };

      const de_json = {
        elements: [
          {
            name: "A-DE1",
            type: "text",
            title: DE_AGE_TITLE,
            inputType: "number",
            min: 18,
            max: 100,
            defaultValue: 0,
            isRequired: true,
          },
          {
            name: "A-DE2",
            type: "radiogroup",
            title: DE_GENDER_TITLE,
            isRequired: true,
            choices: DE_GENDER_CHOICES,
            colCount: 1,
          },
          {
            name: "A-DE6",
            type: "radiogroup",
            title: DE_EDUCATION_TITLE,
            isRequired: true,
            choices: DE_EDUCATION_CHOICES,
            colCount: 1,
          },
          {
            type: "html",
            html: DE_POLITICAL_HTML,
          },
          {
            type: "panel",
            name: "political-social-panel",
            title: DE_POLITICAL_SOCIAL_TITLE,
            elements: [
              {
                name: "A-DE7",
                title: " ",
                type: "slider",
                min: 0,
                max: 100,
                step: 1,
                defaultValue: 50,
                customLabels: [
                  { value: 0, label: DE_POLITICAL_LABELS['0'] },
                  { value: 50, label: DE_POLITICAL_LABELS['50'] },
                  { value: 100, label: DE_POLITICAL_LABELS['100'] },
                ],
                visibleIf: "{A-DE7a} notcontains 'Prefer not to say'"
              },
              {
                name: "A-DE7a",
                type: "checkbox",
                title: " ",
                choices: [DE_PREFER_NOT_TO_SAY],
              }
            ]
          },
          {
            type: "panel",
            name: "political-economic-panel",
            title: DE_POLITICAL_ECONOMIC_TITLE,
            elements: [
              {
                name: "A-DE8",
                type: "slider",
                title: " ",
                min: 0,
                max: 100,
                step: 1,
                defaultValue: 50,
                customLabels: [
                  { value: 0, label: DE_POLITICAL_LABELS['0'] },
                  { value: 50, label: DE_POLITICAL_LABELS['50'] },
                  { value: 100, label: DE_POLITICAL_LABELS['100'] },
                ],
                visibleIf: "{A-DE8a} notcontains 'Prefer not to say'"
              },
              {
                name: "A-DE8a",
                type: "checkbox",
                title: " ",
                choices: [DE_PREFER_NOT_TO_SAY],
              }
            ]
          },
          {
            name: "Comments Box",
            type: "comment",
            title: DE_COMMENTS_TITLE,
          },
        ],
      };

      // fix the prefer not to say item
      const de_trial = {
        type: jsPsychSurvey,
        survey_json: de_json,
        button_label: DE_BUTTON_LABEL,
        on_finish: function (data) {
          if (
            data.response["A-DE7a"] &&
            data.response["A-DE7a"].includes(DE_PREFER_NOT_TO_SAY)
          ) {
            data.response["A-DE7"] = -99;
          }
          if (
            data.response["A-DE8a"] &&
            data.response["A-DE8a"].includes(DE_PREFER_NOT_TO_SAY)
          ) {
            data.response["A-DE8"] = -99;
          }
        },
      };

      timeline.push(who5_trial);
      timeline.push(phq4_trial);
      timeline.push(vams_trial);
      timeline.push(bpaq_trial);
      timeline.push(ac_trial);
      timeline.push(svo_trials);
      timeline.push(tic_trial);
      timeline.push(cce_trial);
      timeline.push(ccj_trial);
      timeline.push(cca_trial);
      timeline.push(ccb_trial);
      timeline.push(ts_trial);
      timeline.push(sta_trial);
      timeline.push(sl_trial);
      timeline.push(de_trial);

      jsPsych.run(timeline);
    </script>
  </body>
</html>
