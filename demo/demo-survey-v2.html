<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HotCog Demo</title>
    <script src="https://unpkg.com/jspsych@8"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-survey-slider"></script>
    <script src="https://unpkg.com/@jspsych/plugin-browser-check"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css"
    />
    <script src="https://unpkg.com/@jspsych/plugin-survey@4.0.0"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@jspsych/plugin-survey@4.0.0/css/survey.min.css"
    />
    <script src="../survey/survey-text.js"></script>
    <script src="../survey/survey-items.js"></script>
    <script src="../survey/vulnerability-items.js"></script>
    <script src="../utility/utility-trials.js"></script>
    <script src="../variants.js"></script>
    <script src="jatos.js"></script>
    <link rel="stylesheet" href="../survey/survey.css">
    <style>
      html { 
        background-color: #f5f5f5;
      } 
    </style>
  </head>
  <body>
    <script>
      const IN_JATOS = typeof jatos !== "undefined";

      /**
       * Assign a variant using batch session data to balance across variants
       * @returns {number} Variant number (1-25)
       */
      async function assignVariant() {
        if (!IN_JATOS) {
          // For local testing, use a random variant
          return Math.floor(Math.random() * 25) + 1;
        }

        // Get current variant counts from batch session
        let variantCounts = jatos.batchSession.get('variantCounts');

        if (!variantCounts) {
          // Initialize variant counts for all 25 variants
          variantCounts = {};
          for (let i = 1; i <= 25; i++) {
            variantCounts[i] = 0;
          }
        }

        // Find the variant with the lowest count
        let minCount = Infinity;
        let availableVariants = [];

        for (let i = 1; i <= 25; i++) {
          const count = variantCounts[i] || 0;
          if (count < minCount) {
            minCount = count;
            availableVariants = [i];
          } else if (count === minCount) {
            availableVariants.push(i);
          }
        }

        // Randomly select from variants with the lowest count
        const assignedVariant = availableVariants[Math.floor(Math.random() * availableVariants.length)];

        // Increment the count for the assigned variant
        variantCounts[assignedVariant] = (variantCounts[assignedVariant] || 0) + 1;

        // Update batch session data
        await jatos.batchSession.set('variantCounts', variantCounts);

        return assignedVariant;
      }

      /**
       * Mark variant as completed in batch session
       */
      async function markVariantCompleted(variantNumber) {
        if (!IN_JATOS) return;

        let completedCounts = jatos.batchSession.get('completedCounts');

        if (!completedCounts) {
          completedCounts = {};
          for (let i = 1; i <= 25; i++) {
            completedCounts[i] = 0;
          }
        }

        completedCounts[variantNumber] = (completedCounts[variantNumber] || 0) + 1;
        await jatos.batchSession.set('completedCounts', completedCounts);
      }

      const jsPsych = initJsPsych({
        on_finish: async function () {
          // Mark variant as completed
          const variantNumber = jsPsych.data.get().values()[0].variant;
          await markVariantCompleted(variantNumber);

          if (IN_JATOS) {
            jatos.startNextComponent(jsPsych.data.get().json())
          } else {
            jsPsych.data.displayData();
          }
        },
        on_trial_finish: function (data) {
          const ts = new Date();
          data.timestamp = ts.toISOString();
          data.timestamp_local = ts.toLocaleTimeString();
        }
      });

      async function runExperiment() {
        // Assign variant
        const variantNumber = await assignVariant();
        console.log(`Assigned to variant ${variantNumber}`);

        // Build timeline for the assigned variant
        const timeline = buildVariantTimeline(variantNumber);

        // Add variant number to all trials
        if (IN_JATOS) {
          const jatos_id = jatos.studyResultId;
          jsPsych.data.addProperties({
            jatos_id: jatos_id,
            variant: variantNumber
          });
        } else {
          jsPsych.data.addProperties({
            variant: variantNumber
          });
        }

        // Run the experiment
        jsPsych.run(timeline);
      }

      if (IN_JATOS) {
        jatos.onLoad(() => {
          runExperiment();
        });
      } else {
        runExperiment();
      }

    </script>
  </body>
</html>
